<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Smart Attendance</title>
    <link rel="stylesheet" href="student.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1>Student Attendance</h1>
        <div id="attendanceSection">
            <h2>QR Code Scanner</h2>
            <div id="reader"></div>
            <button id="startScanner" class="scan-button">Start Scanner</button>
            <div id="scanResult"></div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        const supabaseUrl = 'https://kqvvdrwuxswvdhnufnks.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxdnZkcnd1eHN3dmRobnVmbmtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwMDE5NTQsImV4cCI6MjA1OTU3Nzk1NH0._lReDFt2zxQy9YCG87xmHuXCNfyesJ-di6zLYWTExuc';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // Check if user is authenticated
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = '/';
            throw new Error('No authentication token found');
        }

        function initializeScanner() {
            let html5QrcodeScanner = null;
            const startButton = document.getElementById('startScanner');

            startButton.addEventListener('click', function() {
                if (!html5QrcodeScanner) {
                    html5QrcodeScanner = new Html5QrcodeScanner(
                        "reader", { fps: 10, qrbox: 250 }
                    );
                    
                    html5QrcodeScanner.render(async (decodedText) => {
                        try {
                            const position = await new Promise((resolve, reject) => {
                                navigator.geolocation.getCurrentPosition(resolve, reject, {
                                    enableHighAccuracy: true,
                                    timeout: 5000,
                                    maximumAge: 0
                                });
                            });
                            
                            const response = await fetch('/api/verify_attendance', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${authToken}`
                                },
                                body: JSON.stringify({
                                    session_data: decodedText,
                                    student_location: {
                                        lat: parseFloat(position.coords.latitude.toFixed(6)),
                                        lon: parseFloat(position.coords.longitude.toFixed(6))
                                    }
                                })
                            });
                            
                            const result = await response.json();
                            if (response.ok) {
                                document.getElementById('scanResult').innerHTML = 
                                    `Attendance ${result.status}: Distance ${Math.round(result.distance)}m`;
                            } else {
                                if (response.status === 401) {
                                    alert('Session expired. Please login again.');
                                    localStorage.removeItem('authToken');
                                    window.location.href = '/';
                                } else {
                                    document.getElementById('scanResult').innerHTML = 
                                        `Error: ${result.error}`;
                                }
                            }

                            // Clear scanner after successful submission
                            html5QrcodeScanner.clear();
                            html5QrcodeScanner = null;
                            startButton.textContent = 'Start Scanner';
                            
                        } catch (error) {
                            console.error('Error:', error);
                            document.getElementById('scanResult').innerHTML = 
                                `Error: ${error.message}`;
                        }
                    });
                    startButton.textContent = 'Stop Scanner';
                } else {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                    startButton.textContent = 'Start Scanner';
                }
            });
        }

        // Initialize scanner when page loads
        initializeScanner();
    </script>
</body>
</html>
